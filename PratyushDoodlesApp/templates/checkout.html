<!-- about.html -->
{% extends 'ui/base_page.html' %}
{% block content %}
<div class="container mt-5">
    {% if data.user %}
    {% if data.cart_items and (data.cart_items|length>0) %}
    <div class="row">
        <div class="col-md-4 mx-auto">
            <div class="flex-column m4">
                <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#">
                            <h2>Order Summary</h2>
                        </a>
                    </li>
                </ul>
                <div class="mt-5">
                    {% for cart_item in data.cart_items %}
                    <div id="cart-item-{{ cart_item.product_id }}">
                        {% with cart_item=cart_item, product=cart_item.get_product() %}
                        {% include 'ui/cart_item.html' %}
                        {% endwith %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class=" col-md-6">
            <!-- <div class="container mt-3"> -->
            <div class="flex-column">
                <div class="col-lg-12 mx-auto">
                    <div id="shipping-address" style="display: {% if not data.user.address %} block {% else %} none {% endif%};">
                    </div>
                    <div id="shipping-address-filled" style="display: {% if data.user.address %} block {% else %} none {% endif%};">
                        {% with address=data.user.address %}
                            {% include 'ui/saved_address.html' %}
                        {% endwith %}
                    </div>
                    <div class="total-payable">
                        Total Amount: ₹{{ data.total_amount }}/-
                    </div>
                    <div class="shipping-amount">
                        Shipping Charges: ₹30/-
                    </div>
                    <div class="total-amount-large">
                        <hr class="my-4">
                        Total Payable: ₹{{ data.total_amount + 30 }}/-
                    </div>
                    {% if data.user.address %}
                        <a href="{{ url_for('checkout.initiate_payment') }}">
                            <button class="checkout-button">Pay Now</button>
                        </a>
                    {% else %} 
                        <a href="#shipping-address-container">
                            <button class="checkout-button-disabled">Pay Now</button>
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
        <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="#">Your Cart is Empty</a>
        </li>
    </ul>
    {% endif %}
    {% else %}
    <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
        <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="#">Log-In to access your Cart</a>
        </li>
    </ul>
    {% endif%}
</div>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>

document.addEventListener("DOMContentLoaded", function (event) {
        fetch('/getShippingAddress')
            .then(response => response.text()) // Get the rendered template as HTML
            .then(data => {
                const cartContainer = document.getElementById('shipping-address');
                cartContainer.innerHTML = data; // Insert the template HTML into the container
            })
            .catch(error => {
                console.error('Error:', error);
            });
    });

function onShippingAddressSaved(event) {
    event.preventDefault();

    const recipientName = document.getElementById("recipient_name").value;
    const addressLine1 = document.getElementById("address_line1").value;
    const addressLine2 = document.getElementById("address_line2").value;
    const city = document.getElementById("city").value;
    const state = document.getElementById("state").value;
    const postalCode = document.getElementById("postal_code").value;
    const country = document.getElementById("country").value;
    const phone_number = document.getElementById("phone_number").value;

    const formData = {
        recipient_name: recipientName,
        address_line1: addressLine1,
        address_line2: addressLine2,
        city: city,
        state: state,
        postal_code: postalCode,
        country: country,
        phone_number: phone_number
    };

    socket.emit('updateShippingAddress', {formData: formData});
}

function onAddressUpdated(){
    location.reload();
}

function onShippingAddressEdit(){
    let editAddressField = document.getElementById('shipping-address')
    let editAddressFieldFilled = document.getElementById('shipping-address-filled')

    editAddressField.style.display = 'block'
    editAddressFieldFilled.style.display = 'none'
}

socket.on('addressUpdated', onAddressUpdated)

</script>
{% endblock content %}