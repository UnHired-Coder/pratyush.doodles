<!-- about.html -->
{% extends 'ui/base_page.html' %}
{% block content %}
<div class="container pt-5">
    {% if data.user %}
    {% if data.cart_items and (data.cart_items|length>0) %}
    <div class="row">
        <div class="col-md-4 mx-auto">
            <div class="flex-column m4">
                <ul class="navbar-nav justify-content-end flex-grow-1 pe-3">
                    <li class="nav-item">
                        <a class="nav-link" aria-current="page" href="#">
                            <h2>Order Summary</h2>
                        </a>
                    </li>
                </ul>
                <div class="mt-5">
                    {% for cart_item in data.cart_items %}
                    <div id="cart-item-{{ cart_item.product_id }}">
                        {% with cart_item=cart_item, product=cart_item.get_product() %}
                        {% include 'ui/cart_item.html' %}
                        {% endwith %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class=" col-md-6">
            <!-- <div class="container mt-3"> -->
            <div class="flex-column">
                <div class="col-lg-12 mx-auto">
                    <div id="shipping-address"
                        style="display: {% if not data.user.address %} block {% else %} none {% endif%};">
                    </div>
                    <div id="shipping-address-filled"
                        style="display: {% if data.user.address %} block {% else %} none {% endif%};">
                        {% with address=data.user.address %}
                        {% include 'ui/saved_address.html' %}
                        {% endwith %}
                    </div>
                    <div class="total-payable">
                        Total Amount: ₹{{ data.total_amount }}/-
                    </div>
                    <div class="shipping-amount">
                        Shipping Charges: ₹30/-
                    </div>
                    <div class="total-amount-large">
                        <hr class="my-4">
                        Total Payable: ₹{{ data.total_amount + 30 }}/-
                    </div>
                        <button id="rzp-pay-button"  style="display:  {% if data.user.address %} block {% else %} none {% endif %};" class="dark-button">Pay Now</button>
                    <a style="display: {% if data.user.address %} none {% else %} block {% endif %}; " href="#shipping-address-container">
                        <button class="dark-button-disabled">Pay Now</button>
                    </a>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <div class="row ml-auto">
        <p>
            No items added.
        </p>
        <p>
            Visit <a type="button" class="dark-button" href="{{ url_for('shop.shop') }}"><b>Shop</b></a> to add items.
        </p>
    </div>
    {% endif %}
    {% else %}
    <div class="row ml-auto">
        <p>
            <a type="button" class="dark-button" href="{{ url_for('auth.login') }}"><b>Log-In</b></a> to access your cart
        </p>
    </div>
    {% endif%}
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>

    document.getElementById('rzp-pay-button').onclick = function (e) {
        showLoader();
        fetch('/getOrderOptions')
        .then(response => response.text()) // Get the rendered template as HTML
            .then(data => {
                hideLoader();
                var payload = JSON.parse(data)
                console.log(payload);
                var rzp1 = new Razorpay(payload);
                rzp1.open();
                e.preventDefault();
            })
            .catch(error => {
                hideLoader();
                showError('Error:', error);
            });
    }

    document.addEventListener("DOMContentLoaded", function (event) {
        fetch('/getShippingAddress')
            .then(response => response.text()) // Get the rendered template as HTML
            .then(data => {
                const cartContainer = document.getElementById('shipping-address');
                cartContainer.innerHTML = data; // Insert the template HTML into the container
            })
            .catch(error => {
                showLoader();
            });
    });

    function onShippingAddressSaved(event) {
        showLoader();
        event.preventDefault();

        const recipientName = document.getElementById("recipient_name").value;
        const addressLine1 = document.getElementById("address_line1").value;
        const addressLine2 = document.getElementById("address_line2").value;
        const city = document.getElementById("city").value;
        const state = document.getElementById("state").value;
        const postalCode = document.getElementById("postal_code").value;
        const country = document.getElementById("country").value;
        const phone_number = document.getElementById("phone_number").value;

        const formData = {
            recipient_name: recipientName,
            address_line1: addressLine1,
            address_line2: addressLine2,
            city: city,
            state: state,
            postal_code: postalCode,
            country: country,
            phone_number: phone_number
        };
        
        fetch('/updateShippingAddress', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ formData: formData })
        })
        .then(response => {
            console.log(response);
            response.json()
        })
        .then(data => {
            hideLoader();
            onAddressUpdated();
            console.log(data); // Process the response (e.g., cart update)
        })
        .catch(error => {
            hideLoader();
            showError('Error:', error);
        });

        console.log("Event: updateShippingAddress", formData)
    }

    function onAddressUpdated() {
        location.reload();
    }

    function onShippingAddressEdit() {
        let editAddressField = document.getElementById('shipping-address')
        let editAddressFieldFilled = document.getElementById('shipping-address-filled')

        editAddressField.style.display = 'block'
        editAddressFieldFilled.style.display = 'none'
    }

</script>
{% endblock content %}